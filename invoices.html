<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoices - InventoryPro</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo"><h1>Inventory<span>Pro</span></h1></div>
    <ul class="nav-links">
      <li><a href="index.html" data-tab="dashboard"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="customers.html" data-tab="customers"><i class="fas fa-users"></i> <span>Customers</span></a></li>
      <li><a href="inventory.html" data-tab="inventory"><i class="fas fa-boxes"></i> <span>Inventory</span></a></li>
      <li><a href="sales.html" data-tab="sales"><i class="fas fa-shopping-cart"></i> <span>Sales</span></a></li>
      <li><a href="invoices.html" class="active" data-tab="invoices"><i class="fas fa-file-invoice"></i> <span>Invoices</span></a></li>
      <li><a href="reports.html" data-tab="reports"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
      <li><a href="barcode.html" data-tab="barcode"><i class="fas fa-barcode"></i> <span>Barcode</span></a></li>
      <li><a href="settings.html" data-tab="settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h2>Sales Invoices</h2>
      <div class="user-info">
        <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="User">
        <div>
          <div>Admin User</div>
          <small>Administrator</small>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3>Completed Invoices</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="invoice-search" class="form-control" placeholder="Search by customer, ID, or date..." style="width: 250px;">
          <!-- Optional: Link to create new sale -->
          <button class="btn btn-primary" onclick="window.location.href='sales.html'">
            <i class="fas fa-plus"></i> New Sale
          </button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>Invoice ID</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="invoices-body">
          <tr><td colspan="7" style="text-align:center;">Loading invoices...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- View Invoice Modal -->
  <div id="viewInvoiceModal" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
      <div class="modal-header">
        <h3>Invoice Details</h3>
        <span class="close" id="close-view-invoice">&times;</span>
      </div>
      <div class="modal-body" id="invoice-details">
        <!-- Filled dynamically -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="close-invoice-modal">Close</button>
        <button class="btn btn-warning" id="print-invoice">Print</button>
      </div>
    </div>
  </div>

  <script>
    // ── Utils ───────────────────────────────────────
    function escapeHTML(str) {
      if (typeof str !== 'string') return str || '';
      return str.replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      })[m]);
    }

    function formatCurrency(n) {
      return '$' + parseFloat(n || 0).toFixed(2);
    }

    // ── Supabase ─────────────────────────────────────
    const supabaseUrl = 'https://hrsrtvrrpnwxqhadxhfg.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyc3J0dnJycG53eHFoYWR4aGZnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTAzOTc5MSwiZXhwIjoyMDgwNjE1NzkxfQ.GGWp25rsNdtBoUgwpbuFBU49NMioKXoEcmBnLBzecJ0';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    let allInvoices = [];

    // ── Render Invoices ──────────────────────────────
    function renderInvoices(data) {
      const tbody = document.getElementById('invoices-body');
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No invoices found</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((inv, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>#${escapeHTML(inv.id)}</td>
          <td>${escapeHTML(inv.customer_name)}</td>
          <td>${new Date(inv.date).toLocaleDateString()}</td>
          <td>${formatCurrency(inv.total)}</td>
          <td><span class="btn ${inv.status === 'Paid' ? 'btn-success' : 'btn-warning'}">${escapeHTML(inv.status)}</span></td>
          <td>
            <button class="btn btn-info" onclick="viewInvoice('${inv.id}')"><i class="fas fa-eye"></i></button>
            <button class="btn btn-danger" onclick="deleteInvoice('${inv.id}')"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    // ── View Invoice ─────────────────────────────────
    function viewInvoice(id) {
      const invoice = allInvoices.find(inv => inv.id === id);
      if (!invoice) return;

      let itemsHtml = '<ul style="padding-left:20px;">';
      (invoice.items || []).forEach(item => {
        itemsHtml += `<li>${escapeHTML(item.name)} × ${item.qty} = ${formatCurrency(item.price * item.qty)}</li>`;
      });
      itemsHtml += '</ul>';

      document.getElementById('invoice-details').innerHTML = `
        <div><strong>Invoice ID:</strong> #${escapeHTML(invoice.id)}</div>
        <div><strong>Customer:</strong> ${escapeHTML(invoice.customer_name)}</div>
        <div><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</div>
        <div><strong>Status:</strong> <span class="btn ${invoice.status === 'Paid' ? 'btn-success' : 'btn-warning'}">${invoice.status}</span></div>
        <div style="margin-top:15px;"><strong>Items:</strong></div>
        ${itemsHtml}
        <div style="margin-top:15px; display: flex; justify-content: space-between; font-weight: bold; padding-top: 10px; border-top: 1px solid #eee;">
          <span>Subtotal:</span> <span>${formatCurrency(invoice.subtotal)}</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>Tax:</span> <span>${formatCurrency(invoice.tax)}</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 1.2rem;">
          <span>Total:</span> <span>${formatCurrency(invoice.total)}</span>
        </div>
      `;

      document.getElementById('viewInvoiceModal').style.display = 'flex';
    }

    // ── Delete Invoice ───────────────────────────────
    async function deleteInvoice(id) {
      if (!confirm('Are you sure you want to delete this invoice? This cannot be undone.')) return;

      try {
        const { error } = await supabase.from('sales').delete().eq('id', id);
        if (error) throw error;
        loadInvoices();
        alert('Invoice deleted.');
      } catch (err) {
        console.error('Delete error:', err);
        alert('Failed to delete invoice: ' + (err.message || 'Unknown error'));
      }
    }

    // ── Search Invoices ──────────────────────────────
    function filterInvoices(searchTerm) {
      if (!searchTerm.trim()) {
        renderInvoices(allInvoices);
        return;
      }

      const term = searchTerm.toLowerCase();
      const filtered = allInvoices.filter(inv =>
        inv.id.toLowerCase().includes(term) ||
        inv.customer_name.toLowerCase().includes(term) ||
        new Date(inv.date).toLocaleDateString().toLowerCase().includes(term)
      );

      renderInvoices(filtered);
    }

    // ── Load Invoices ────────────────────────────────
    async function loadInvoices() {
      try {
        const { data, error } = await supabase
          .from('sales')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;
        allInvoices = data;
        renderInvoices(data);
      } catch (err) {
        console.error('Load invoices error:', err);
        document.getElementById('invoices-body').innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Failed to load invoices</td></tr>`;
      }
    }

    // ── Modal Functions ──────────────────────────────
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    // ── Init ─────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', () => {
      // Search
      document.getElementById('invoice-search').addEventListener('input', (e) => {
        filterInvoices(e.target.value);
      });

      // Modal close
      document.getElementById('close-view-invoice').addEventListener('click', () => closeModal('viewInvoiceModal'));
      document.getElementById('close-invoice-modal').addEventListener('click', () => closeModal('viewInvoiceModal'));
      document.getElementById('print-invoice').addEventListener('click', () => {
        alert('Print feature can be enhanced with PDF generator.');
      });

      // Load
      loadInvoices();
    });

    // Expose globally for inline onclick
    window.viewInvoice = viewInvoice;
    window.deleteInvoice = deleteInvoice;
  </script>
</body>
</html>