<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - InventoryPro</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    @media print {
      .sidebar, .header, .table-header button, .btn:not(.print-only) {
        display: none !important;
      }
      body { margin: 0; }
      .main-content { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo"><h1>Inventory<span>Pro</span></h1></div>
    <ul class="nav-links">
      <li><a href="index.html" class="active" data-tab="dashboard"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="customers.html" data-tab="customers"><i class="fas fa-users"></i> <span>Customers</span></a></li>
      <li><a href="inventory.html" data-tab="inventory"><i class="fas fa-boxes"></i> <span>Inventory</span></a></li>
      <li><a href="sales.html" data-tab="sales"><i class="fas fa-shopping-cart"></i> <span>Sales</span></a></li>
      <li><a href="invoices.html" data-tab="invoices"><i class="fas fa-file-invoice"></i> <span>Invoices</span></a></li>
      <li><a href="reports.html" data-tab="reports"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
      <li><a href="barcode.html" data-tab="barcode"><i class="fas fa-barcode"></i> <span>Barcode</span></a></li>
      <li><a href="settings.html" data-tab="settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="header">
      <h2>Dashboard</h2>
      <div class="user-info">
        <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="User">
        <div>
          <div>Admin User</div>
          <small>Administrator</small>
        </div>
      </div>
    </div>

    <!-- Dashboard Summary Cards -->
    <div class="dashboard-cards">
      <div class="card">
        <div class="card-icon" style="background: rgba(67, 97, 238, 0.2); color: var(--primary);">
          <i class="fas fa-users"></i>
        </div>
        <div class="card-content">
          <h3 id="total-customers">0</h3>
          <p>Total Customers</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(76, 201, 240, 0.2); color: var(--success);">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="card-content">
          <h3 id="total-products">0</h3>
          <p>Products</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(46, 204, 113, 0.2); color: #2ecc71;">
          <i class="fas fa-warehouse"></i>
        </div>
        <div class="card-content">
          <h3 id="inventory-value">$0</h3>
          <p>Inventory Value</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c;">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="card-content">
          <h3 id="low-stock-count">0</h3>
          <p>Low Stock Items</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(248, 150, 30, 0.2); color: var(--warning);">
          <i class="fas fa-receipt"></i>
        </div>
        <div class="card-content">
          <h3 id="today-sales-count">0</h3>
          <p>Sales Today</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(41, 128, 185, 0.2); color: #2980b9;">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="card-content">
          <h3 id="today-sales-total">$0</h3>
          <p>Today's Sales</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(39, 174, 96, 0.2); color: #27ae60;">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="card-content">
          <h3 id="today-profit">$0</h3>
          <p>Today's Profit</p>
        </div>
      </div>
      <div class="card">
        <div class="card-icon" style="background: rgba(155, 89, 182, 0.2); color: #9b59b6;">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="card-content">
          <h3 id="total-revenue">$0</h3>
          <p>Total Revenue</p>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <h3>Sales Overview</h3>
      </div>
      <canvas id="salesChart" height="300"></canvas>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3>Recent Sales</h3>
        <button class="btn btn-primary" onclick="window.location.href='sales.html'">
          <i class="fas fa-plus"></i> New Sale
        </button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Invoice ID</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recent-sales-body">
          <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHTML(str) {
      if (typeof str !== 'string') return str || '';
      return str.replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      })[m]);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount || 0);
    }

    // â”€â”€ Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ðŸ”¥ FIXED: Removed trailing spaces!
    const supabaseUrl = 'https://hrsrtvrrpnwxqhadxhfg.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyc3J0dnJycG53eHFoYWR4aGZnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTAzOTc5MSwiZXhwIjoyMDgwNjE1NzkxfQ.GGWp25rsNdtBoUgwpbuFBU49NMioKXoEcmBnLBzecJ0';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // â”€â”€ Action Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function editSale(id) {
      window.location.href = `sales.html?edit=${id}`;
    }

    async function deleteSale(id) {
      if (!confirm('Are you sure you want to delete this sale? This cannot be undone.')) return;
      try {
        const { error } = await supabase.from('sales').delete().eq('id', id);
        if (error) throw error;
        alert('Sale deleted successfully!');
        loadDashboardData();
      } catch (err) {
        console.error('Delete error:', err);
        alert('Failed to delete sale: ' + (err.message || 'Unknown error'));
      }
    }

    // â”€â”€ Open real invoice page
    function viewOrPrintInvoice(saleId, printMode = false) {
      const url = `invoice.html?id=${encodeURIComponent(saleId)}`;
      if (printMode) {
        // Open in new tab and focus for print
        const win = window.open(url, '_blank');
        if (win) win.focus();
      } else {
        window.location.href = url;
      }
    }

    // â”€â”€ Load Dashboard Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDashboardData() {
      const today = new Date().toISOString().split('T')[0];
      try {
        const [customersRes, productsRes, salesRes] = await Promise.all([
          supabase.from('customers').select('*', { count: 'exact', head: false }),
          supabase.from('products').select('*'),
          supabase.from('sales').select('*')
        ]);

        if (customersRes.error) throw customersRes.error;
        if (productsRes.error) throw productsRes.error;
        if (salesRes.error) throw salesRes.error;

        const customerCount = customersRes.count || 0;
        const products = productsRes.data || [];
        const sales = salesRes.data || [];

        // Inventory Summary
        let inventoryValue = 0, lowStockCount = 0;
        const LOW_STOCK_THRESHOLD = 5;
        products.forEach(p => {
          const qty = parseFloat(p.quantity) || 0;
          const price = parseFloat(p.price) || 0;
          inventoryValue += qty * price;
          if (qty <= LOW_STOCK_THRESHOLD) lowStockCount++;
        });

        // Sales Summary
        const todaySales = sales.filter(s => s.date?.startsWith(today));
        const todaySalesCount = todaySales.length;
        const todaySalesTotal = todaySales.reduce((sum, s) => sum + (parseFloat(s.total) || 0), 0);
        const todayProfit = todaySales.reduce((sum, s) => sum + (parseFloat(s.profit) || 0), 0);
        const totalRevenue = sales.reduce((sum, s) => sum + (parseFloat(s.total) || 0), 0);

        // Update UI
        document.getElementById('total-customers').textContent = customerCount;
        document.getElementById('total-products').textContent = products.length;
        document.getElementById('inventory-value').textContent = formatCurrency(inventoryValue);
        document.getElementById('low-stock-count').textContent = lowStockCount;
        document.getElementById('today-sales-count').textContent = todaySalesCount;
        document.getElementById('today-sales-total').textContent = formatCurrency(todaySalesTotal);
        document.getElementById('today-profit').textContent = formatCurrency(todayProfit);
        document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);

        // Render Recent Sales with data attributes (safe!)
        const recentSales = sales
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 3);

        const tbody = document.getElementById('recent-sales-body');
        if (recentSales.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No recent sales</td></tr>';
        } else {
          tbody.innerHTML = recentSales.map(s => `
            <tr>
              <td>#${escapeHTML(s.id)}</td>
              <td>${escapeHTML(s.customer_name || 'â€”')}</td>
              <td>${s.date ? new Date(s.date).toLocaleDateString() : 'â€”'}</td>
              <td>${formatCurrency(s.total)}</td>
              <td>
                <span class="btn ${s.status === 'Paid' ? 'btn-success' : 'btn-warning'}">
                  ${escapeHTML(s.status || 'Pending')}
                </span>
              </td>
              <td>
                <button class="btn btn-info view-btn" data-id="${s.id}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-warning edit-btn" data-id="${s.id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger delete-btn" data-id="${s.id}">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-secondary print-btn" data-id="${s.id}">
                  <i class="fas fa-print"></i>
                </button>
              </td>
            </tr>
          `).join('');
        }

        // Attach event listeners (event delegation not needed since we re-render)
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').dataset.id;
            viewOrPrintInvoice(id, false);
          });
        });
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').dataset.id;
            editSale(id);
          });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').dataset.id;
            deleteSale(id);
          });
        });
        document.querySelectorAll('.print-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').dataset.id;
            viewOrPrintInvoice(id, true);
          });
        });

      } catch (err) {
        console.error('Dashboard load error:', err);
        document.getElementById('recent-sales-body').innerHTML = 
          '<tr><td colspan="6" style="text-align:center;color:red;">Error loading data</td></tr>';
      }
    }

    // â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initCharts() {
      const ctx = document.getElementById('salesChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Sales ($)',
            data: [12000, 19000, 15000, 18000, 22000, 19500],
            borderColor: '#4361ee',
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardData();
      initCharts();
    });
  </script>
</body>
</html>
