<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customers - InventoryPro</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo"><h1>Inventory<span>Pro</span></h1></div>
    <ul class="nav-links">
      <li><a href="index.html" data-tab="dashboard"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="customers.html" class="active" data-tab="customers"><i class="fas fa-users"></i> <span>Customers</span></a></li>
      <li><a href="inventory.html" data-tab="inventory"><i class="fas fa-boxes"></i> <span>Inventory</span></a></li>
      <li><a href="sales.html" data-tab="sales"><i class="fas fa-shopping-cart"></i> <span>Sales</span></a></li>
      <li><a href="invoices.html" data-tab="invoices"><i class="fas fa-file-invoice"></i> <span>Invoices</span></a></li>
      <li><a href="reports.html" data-tab="reports"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
      <li><a href="barcode.html" data-tab="barcode"><i class="fas fa-barcode"></i> <span>Barcode</span></a></li>
      <li><a href="settings.html" data-tab="settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h2>Customer Management</h2>
      <div class="user-info">
        <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="User">
        <div>
          <div>Admin User</div>
          <small>Administrator</small>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3>Customers</h3>
        <button class="btn btn-primary" id="add-customer-btn">
          <i class="fas fa-plus"></i> Add Customer
        </button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customers-body">
          <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Customer Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Add New Customer</h3>
        <span class="close" id="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label for="customerId">Customer ID</label>
            <input type="text" class="form-control" id="customerId" readonly>
          </div>
          <div class="form-group">
            <label for="customerName">Full Name</label>
            <input type="text" class="form-control" id="customerName" placeholder="Enter customer name">
          </div>
          <div class="form-group">
            <label for="customerEmail">Email</label>
            <input type="email" class="form-control" id="customerEmail" placeholder="Enter email">
          </div>
          <div class="form-group">
            <label for="customerType">Customer Type</label>
            <select class="form-control" id="customerType">
              <option value="individual">Individual</option>
              <option value="business">Business</option>
            </select>
          </div>
          <div class="form-group">
            <label for="customerPhone">Phone</label>
            <input type="text" class="form-control" id="customerPhone" placeholder="Enter phone number">
          </div>
          <div class="form-group">
            <label for="customerAddress">Address</label>
            <input type="text" class="form-control" id="customerAddress" placeholder="Enter address">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-customer">Cancel</button>
        <button class="btn btn-primary" id="save-customer">Save Customer</button>
      </div>
    </div>
  </div>

  <script>
    // ── Utils ───────────────────────────────────────
    function escapeHTML(str) {
      if (typeof str !== 'string') return str || '';
      return str.replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      })[m]);
    }

    // ── Supabase (NO TRAILING SPACES!) ───────────────
    const supabaseUrl = 'https://hrsrtvrrpnwxqhadxhfg.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyc3J0dnJycG53eHFoYWR4aGZnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTAzOTc5MSwiZXhwIjoyMDgwNjE1NzkxfQ.GGWp25rsNdtBoUgwpbuFBU49NMioKXoEcmBnLBzecJ0';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // ── Global State ─────────────────────────────────
    let editingCustomerId = null;
    let allCustomers = [];
    let appSettings = {
      customer_id_prefix: 'CUST',
      require_email: true,
      default_customer_type: 'individual'
    };

    // ── Apply Settings ───────────────────────────────
    function applySettings(settings) {
      appSettings = { ...appSettings, ...settings };
      console.log('✅ Settings applied:', appSettings);
    }

    // ── Load Initial Settings ────────────────────────
    async function loadInitialSettings() {
      try {
        const {  settings, error } = await supabase
          .from('settings')
          .select('*')
          .eq('id', 1)
          .single();

        if (error?.code === 'PGRST116') {
          const defaultSettings = {
            id: 1,
            customer_id_prefix: 'CUST',
            require_email: true,
            default_customer_type: 'individual'
          };
          await supabase.from('settings').insert([defaultSettings]);
          applySettings(defaultSettings);
        } else if (error) {
          throw error;
        } else {
          applySettings(settings);
        }
      } catch (err) {
        console.error('❌ Initial settings load failed:', err);
      }
    }

    // ── REALTIME SETTINGS SYNC ───────────────────────
    function setupRealtimeSettings() {
      const channel = supabase
        .channel('settings-changes')
        .on(
          'postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'settings', filter: 'id=eq.1' },
          (payload) => applySettings(payload.new)
        )
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'settings', filter: 'id=eq.1' },
          (payload) => applySettings(payload.new)
        )
        .subscribe((status, err) => {
          if (err) {
            console.error('❌ Realtime subscription error:', err);
          } else {
            console.log('✅ Realtime status:', status);
          }
        });

      window.addEventListener('beforeunload', () => {
        supabase.removeChannel(channel);
      });
    }

    // ── Modal & CRUD (same as before) ────────────────
    function openModal() {
      document.getElementById('customerModal').style.display = 'flex';
      document.getElementById('modal-title').textContent = editingCustomerId ? 'Edit Customer' : 'Add New Customer';
      document.getElementById('save-customer').textContent = editingCustomerId ? 'Update Customer' : 'Save Customer';

      if (!editingCustomerId) {
        const prefix = appSettings.customer_id_prefix || 'CUST';
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('customerId').value = `${prefix}-${randomNum}`;
        document.getElementById('customerName').value = '';
        document.getElementById('customerEmail').value = '';
        document.getElementById('customerType').value = appSettings.default_customer_type;
        document.getElementById('customerPhone').value = '';
        document.getElementById('customerAddress').value = '';
      }
    }

    function closeModal() {
      document.getElementById('customerModal').style.display = 'none';
      editingCustomerId = null;
    }

    async function loadCustomers() {
      const tbody = document.getElementById('customers-body');
      try {
        const { data, error } = await supabase
          .from('customers')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;
        allCustomers = data;
        renderCustomers(data);
      } catch (err) {
        console.error('Load customers error:', err);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Failed to load customers</td></tr>`;
      }
    }

    function renderCustomers(data) {
      const tbody = document.getElementById('customers-body');
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No customers found</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(c => `
        <tr>
          <td>${escapeHTML(c.id)}</td>
          <td>${escapeHTML(c.name)}</td>
          <td>${escapeHTML(c.email || '—')}</td>
          <td>${escapeHTML(c.phone || '—')}</td>
          <td>${escapeHTML(c.address || '—')}</td>
          <td>
            <button class="btn btn-info view-btn" data-id="${c.id}"><i class="fas fa-eye"></i></button>
            <button class="btn btn-warning edit-btn" data-id="${c.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger delete-btn" data-id="${c.id}"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');

      // Attach listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = (e) => editCustomer(e.target.closest('button').dataset.id);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => deleteCustomer(e.target.closest('button').dataset.id);
      });
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.onclick = (e) => {
          const id = e.target.closest('button').dataset.id;
          const cust = allCustomers.find(c => c.id === id);
          alert(`ID: ${cust.id}\nName: ${cust.name}\nEmail: ${cust.email || '—'}`);
        };
      });
    }

    function editCustomer(id) {
      const customer = allCustomers.find(c => c.id === id);
      if (!customer) return;
      editingCustomerId = id;
      document.getElementById('customerId').value = customer.id;
      document.getElementById('customerName').value = customer.name || '';
      document.getElementById('customerEmail').value = customer.email || '';
      document.getElementById('customerType').value = customer.type || appSettings.default_customer_type;
      document.getElementById('customerPhone').value = customer.phone || '';
      document.getElementById('customerAddress').value = customer.address || '';
      openModal();
    }

    async function saveCustomer() {
      const btn = document.getElementById('save-customer');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      const id = document.getElementById('customerId').value.trim();
      const name = document.getElementById('customerName').value.trim();
      const email = document.getElementById('customerEmail').value.trim();
      const type = document.getElementById('customerType').value;
      const phone = document.getElementById('customerPhone').value.trim();
      const address = document.getElementById('customerAddress').value.trim();

      if (!name) {
        alert('Name is required.');
        btn.disabled = false;
        btn.innerHTML = editingCustomerId ? 'Update Customer' : 'Save Customer';
        return;
      }

      if (appSettings.require_email && !email) {
        alert('Email is required (per current settings).');
        btn.disabled = false;
        btn.innerHTML = editingCustomerId ? 'Update Customer' : 'Save Customer';
        return;
      }

      try {
        const data = { name, email, type, phone, address };
        if (editingCustomerId) {
          const { error } = await supabase.from('customers').update(data).eq('id', editingCustomerId);
          if (error) throw error;
          alert('Customer updated!');
        } else {
          data.id = id;
          const { error } = await supabase.from('customers').insert([data]);
          if (error) throw error;
          alert('Customer added!');
        }
        closeModal();
        loadCustomers();
      } catch (err) {
        console.error('Save error:', err);
        alert('Failed to save: ' + (err.message || 'Unknown error'));
      } finally {
        btn.disabled = false;
        btn.innerHTML = editingCustomerId ? 'Update Customer' : 'Save Customer';
      }
    }

    async function deleteCustomer(id) {
      if (!confirm('Delete this customer?')) return;
      try {
        const { error } = await supabase.from('customers').delete().eq('id', id);
        if (error) throw error;
        loadCustomers();
      } catch (err) {
        console.error('Delete error:', err);
        alert('Delete failed: ' + (err.message || 'Unknown error'));
      }
    }

    function filterCustomers(term) {
      const filtered = term.trim()
        ? allCustomers.filter(c => 
            `${c.id} ${c.name} ${c.email} ${c.phone} ${c.address}`.toLowerCase().includes(term.toLowerCase())
          )
        : allCustomers;
      renderCustomers(filtered);
    }

    // ── Init ─────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', async () => {
      await loadInitialSettings();
      setupRealtimeSettings();

      const searchHTML = `<div style="margin-bottom:15px;"><input type="text" id="customer-search" class="form-control" placeholder="Search customers..."></div>`;
      document.querySelector('.table-header').insertAdjacentHTML('beforeend', searchHTML);

      document.getElementById('add-customer-btn').addEventListener('click', openModal);
      document.getElementById('close-modal').addEventListener('click', closeModal);
      document.getElementById('cancel-customer').addEventListener('click', closeModal);
      document.getElementById('save-customer').addEventListener('click', saveCustomer);
      document.getElementById('customer-search').addEventListener('input', (e) => filterCustomers(e.target.value));

      loadCustomers();
    });
  </script>
</body>
</html>
